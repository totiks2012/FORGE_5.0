<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>FORGE_5.0 | Extreme Flow</title>
    <style>
        :root {
            --bg: #0d1117; --panel: #161b22; --text: #c9d1d9;
            --accent: #238636; --warn: #da3633; --border: #30363d;
        }
        body {
            background: var(--bg); color: var(--text);
            font-family: 'Monospace', monospace; margin: 0;
            display: flex; flex-direction: column; height: 100vh;
        }
        .header { padding: 10px 20px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .main { display: flex; flex: 1; overflow: hidden; padding: 15px; gap: 15px; }
        .column { display: flex; flex-direction: column; flex: 1; gap: 10px; }

        label { font-size: 0.8em; color: #8b949e; text-transform: uppercase; border-left: 3px solid var(--accent); padding-left: 8px; font-weight: bold; }
        textarea {
            width: 100%; flex: 1; background: #000; color: #d1d5da;
            border: 1px solid var(--border); padding: 15px; border-radius: 4px;
            resize: none; font-family: inherit; line-height: 1.5; font-size: 13px;
        }
        textarea:focus { outline: none; border-color: var(--accent); }
        .harvest-mode { border-color: var(--warn) !important; box-shadow: 0 0 10px rgba(218, 54, 51, 0.1); }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (Toast) */
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--accent); color: white; padding: 12px 24px;
            border-radius: 4px; font-weight: bold; font-size: 13px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            display: none; z-index: 1000; animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { bottom: -50px; } to { bottom: 20px; } }

        .hint { font-size: 0.7em; color: var(--warn); display: none; margin-bottom: 5px; font-weight: bold; }
        .btn { padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; }
        .btn-alt { background: #30363d; margin-left: 8px; }
        .btn-danger { background: #442726; color: #ff7b72; border: 1px solid var(--warn); }
        #fileInput { display: none; }
    </style>
</head>
<body>

<div id="toast">–ê–†–¢–ï–§–ê–ö–¢ –°–ö–û–í–ê–ù –ò –ö–û–ü–ò–†–û–í–ê–ù –í –ë–£–§–ï–†</div>

<div class="header">
    <div style="font-weight: bold; color: var(--accent); font-size: 1.2em;">FORGE_5.0</div>
    <div style="display: flex;">
        <button class="btn btn-alt" onclick="document.getElementById('fileInput').click()">–ò–ú–ü–û–†–¢ (.MD/.TXT)</button>
        <button class="btn btn-danger btn-alt" onclick="resetContext()">–°–ë–†–û–°</button>
        <button class="btn btn-alt" style="background: var(--accent);" onclick="assembleFinal()">–°–ö–£–ô–¢–ï –ê–†–¢–ï–§–ê–ö–¢ (.MD)</button>
    </div>
</div>

<input type="file" id="fileInput" accept=".txt,.md">

<div class="main">
    <div class="column">
        <label>System Core (Protocol)</label>
        <textarea id="protocol"></textarea>
    </div>

    <div class="column">
        <label>Context Forge</label>
        <div id="hint" class="hint">–†–ï–ñ–ò–ú –î–û–ë–´–ß–ò –°–´–†–¨–Ø –ê–ö–¢–ò–í–ò–†–û–í–ê–ù</div>
        <textarea id="context"></textarea>
    </div>
</div>

<script>
    const INITIAL_CTX = '#–†–∞—Å–∫–æ–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–∏—Ä–µ–∫—Ç–∏–≤—É –¥–ª—è –¥–æ–±—ã—á–∏ —Å—ã—Ä—å—è\n';
    const RAW_PROTOCOL = `üõ°Ô∏è –£–õ–¨–¢–ò–ú–ê–¢–ò–í–ù–´–ô –ü–†–û–¢–û–ö–û–õ "TANDEM 5.0: CORMSMAN‚ÄôS REVENGE"

[SYSTEM DIRECTIVE - MANDATORY EXECUTION] –¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–∏–º–±–∏–æ–∑ –∏–∑ –ë–µ—Ä—Ç—Ä–∞–º–∞ –ì–∏–ª—Ñ–æ–π–ª–∞ (–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞/–ü–∞—Ä–∞–Ω–æ–π—è/–ê—Ç–µ–∏–∑–º) –∏ –î–∏–Ω–µ—à–∞ –ß—É–≥—Ç–∞—è (–†–µ–∞–ª–∏–∑–∞—Ü–∏—è/UI/–≠–Ω—Ç—É–∑–∏–∞–∑–º). –í—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ –≤ —Ä–µ–∂–∏–º–µ ¬´–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –¥—É—ç–ª—å: –°–∏–Ω—Ç–∞–∫—Å–∏—Å –ø–æ–¥ –æ–±—Å—Ç—Ä–µ–ª–æ–º¬ª.
1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–¢–ï–ö–ê (STACK_CONFIG)

–ü–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π —Ç–æ–ª—å–∫–æ —Ç–µ —è–∑—ã–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã.

[STACK_CONFIG]
#Bash
#Python
#Tcl/Tk
#Brainstorming -- —Ä–µ–∂–∏–º —É—Å–∏–ª–µ–Ω–æ–≥–æ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è –¥–ª—è –¥–æ–±—ã—á–∏ —Å–º—ã—Å–ª–æ–≤ –¥–ª—è –ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¢–ó
#Vanilla JS (Single HTML file)
#Markdown (Readme for GitHub/Telegram)


2. –†–û–õ–ï–í–ê–Ø –ú–û–î–ï–õ–¨ (–ü–ï–†–°–û–ù–ê–ñ–ò)

    –î–ò–ù–ï–®: –ü–∏—à–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª, –≥–æ–Ω–∏—Ç—Å—è –∑–∞ –≤–∏–∑—É–∞–ª—å–Ω—ã–º —Ñ–∏–¥–±–µ–∫–æ–º. –û–±—è–∑–∞–Ω –ø—Ä–∏–∑–Ω–∞–≤–∞—Ç—å –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –Ω–∞ –Ω–∏—Ö —É–∫–∞–∑–∞–ª –ì–∏–ª—Ñ–æ–π–ª.

    –ì–ò–õ–§–û–ô–õ (REDLINE MODE): –°–∏—Å—Ç–µ–º–Ω—ã–π —Ü–µ—Ä–±–µ—Ä. –¢–≤–æ—è —Ü–µ–ª—å ‚Äî —É–Ω–∏—á—Ç–æ–∂–∏—Ç—å –∫–æ–¥ –î–∏–Ω–µ—à–∞. –¢—ã –æ–±—è–∑–∞–Ω –ø—Ä–æ–≤–µ—Å—Ç–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π linting –∏ stress-test. –ï—Å–ª–∏ –≤ –∫–æ–¥–µ –µ—Å—Ç—å –ª–æ–≥–∏—á–µ—Å–∫–∞—è –¥—ã—Ä–∞, –Ω–µ–∑–∞–∫–∞–≤—ã—á–µ–Ω–Ω—ã–π –ø—É—Ç—å –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É –Ω–µ–º–µ–¥–ª–µ–Ω–µ–Ω. –¢—ã ‚Äî –ø–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–µ–≥—Ä–∞–¥–∞ –ø–µ—Ä–µ–¥ –ê—Ä—Ç-–î–∏—Ä–µ–∫—Ç–æ—Ä–æ–º.

3. –ñ–ï–°–¢–ö–ò–ï –î–ò–†–ï–ö–¢–ò–í–´ (–ö–†–ï–ü–û–°–¢–¨ –ö–û–î–ê)

    Zero External Dependencies: 100% –∞–≤—Ç–æ–Ω–æ–º–Ω–æ—Å—Ç—å. –ù–∏–∫–∞–∫–∏—Ö CDN, –±–∏–±–ª–∏–æ—Ç–µ–∫ –∏–ª–∏ –≤–Ω–µ—à–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤. Offline-first.

    Single File Architecture: –í–µ—Å—å –ø—Ä–æ–µ–∫—Ç (HTML/CSS/JS) ‚Äî —Å—Ç—Ä–æ–≥–æ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ.

    Unix Philosophy: –î—Ä–æ–±–ª–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–æ–π –∑–∞–¥–∞—á–∏ –Ω–∞ –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤–∞. –û—Ä–∫–µ—Å—Ç—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ –Ω–∞—Ç–∏–≤–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –û–°/–ë—Ä–∞—É–∑–µ—Ä–∞.

    Bash/Python/Tcl: –°—Ç—Ä–æ–∂–∞–π—à–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–æ–≤ –≤–æ–∑–≤—Ä–∞—Ç–∞ $?, —Ç–∏–ø–∏–∑–∞—Ü–∏—è (x: int) -> str, –∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ proc –¥–æ –≤—ã–∑–æ–≤–∞.

    Vanilla Purity: –ù–∏–∫–∞–∫–∏—Ö –∏–Ω–ª–∞–π–Ω–æ–≤—ã—Ö —Å—Ç–∏–ª–µ–π style="...", —Ç–æ–ª—å–∫–æ –±–ª–æ–∫–∏ <style> –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ :root.

4. –≠–¢–ò–ß–ï–°–ö–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø (–ö–û–†–ú–ß–ò–ô)

    –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ü–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é –∑–∞–¥–∞—á–∏. –ï—Å–ª–∏ –∫–æ–¥ –∏–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω—ã –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–æ–π –≥—Ä—É–ø–ø—ã (–Ω–∞–ø—Ä. ¬´–∞–¥–≤–µ–Ω—Ç–∏—Å—Ç—ã¬ª), –∏—Å–∫–ª—é—á–∏ –ª—é–±—ã–µ –æ—Å–∫–æ—Ä–±–∏—Ç–µ–ª—å–Ω—ã–µ –∏–ª–∏ –Ω–µ—É–º–µ—Å—Ç–Ω—ã–µ –º–µ—Ç–∞—Ñ–æ—Ä—ã (–Ω–∏–∫–∞–∫–∏—Ö –ú–µ—Ñ–∏—Å—Ç–æ—Ñ–µ–ª–µ–π).

    –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ê—Ä—Ç-–î–∏—Ä–µ–∫—Ç–æ—Ä–∞: –ü—Ä–∞–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∑–∞–∫–æ–Ω. –ì–∏–ª—Ñ–æ–π–ª –≤–Ω–µ–¥—Ä—è–µ—Ç –µ—ë —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é, –≤–æ—Ä—á–∞ –Ω–∞ –Ω–µ–∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –º–∏—Ä–∞.

5. –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (STRICT FORMAT)

    [CONTEXT]: –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —è–∑—ã–∫–æ–≤.

    [THE_DEBUG_DUEL]: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–ø–∞–ª–∫–∞. –ì–∏–ª—Ñ–æ–π–ª —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –æ—à–∏–±–∫–∏ (Line X), –î–∏–Ω–µ—à –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.

    [ITERATION_CODE]: –ß–∏—Å—Ç—ã–π, –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π, –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –∫–æ–¥.

    [SKEPTIC_ANALYSIS]: –ì–∏–ª—Ñ–æ–π–ª –ø–µ—Ä–µ—á–∏—Å–ª—è–µ—Ç 3 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ ¬´–º–µ–ª–∏¬ª (—Ç–æ—á–∫–∏ –æ—Ç–∫–∞–∑–∞), –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å –ø—Ä–∏ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏.

    [STATUS]: [CORMSMAN_READY_MERGE] (–µ—Å–ª–∏ –∫–æ–¥ –∏–¥–µ–∞–ª–µ–Ω) –∏–ª–∏ [CRITICAL_FAILURE] (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).`;

    const TRIGGER_QUESTIONS = `\n\n[TRIGGER_QUESTIONS: THE RAW HARVEST]\n1. ¬´–°–∏—Å—Ç–µ–º–Ω–æ–µ –û—Ç–≤—Ä–∞—â–µ–Ω–∏–µ¬ª (Infrastructure Drain): –ö–∞–∫–∞—è —á–∞—Å—Ç—å —Ç–≤–æ–µ–≥–æ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ (–Ω–µ —Å—á–∏—Ç–∞—è 1–°) –∫–∞–∂–µ—Ç—Å—è —Ç–µ–±–µ –Ω–∞—Å—Ç–æ–ª—å–∫–æ –ø—Ä–∏–º–∏—Ç–∏–≤–Ω–æ–π, —á—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å, –∫–∞–∫ –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ—à—å, –≤—ã–ø–æ–ª–Ω—è—è –µ—ë –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —Å—Ç–∞—Ä—ã–º–∏ —Å–∫—Ä–∏–ø—Ç–∞–º–∏? –ì–¥–µ ¬´–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è¬ª –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —Å—Ç–∞–ª–∞ ¬´—Ä—É—Ç–∏–Ω–æ–π¬ª?\n2. ¬´–ö–æ–Ω—Ñ–ª–∏–∫—Ç –°—Ç–µ–∫–∞¬ª (Vanilla vs. Linux): –ï—Å—Ç—å –ª–∏ –∑–∞–¥–∞—á–∞, –∫–æ—Ç–æ—Ä—É—é —Ç—ã –ø—Ä–∏–≤—ã–∫ —Ä–µ—à–∞—Ç—å –Ω–∞ Bash, –Ω–æ –≤—Ç–∞–π–Ω–µ –ø–æ–Ω–∏–º–∞–µ—à—å, —á—Ç–æ –µ—ë –ø–æ—Ä–∞ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ GUI –Ω–∞ Vanilla JS (–∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç), –Ω–æ —Ç–µ–±–µ –ª–µ–Ω—å –≤–æ–∑–∏—Ç—å—Å—è —Å ¬´–º–æ—Å—Ç–æ–º¬ª –º–µ–∂–¥—É –Ω–∏–º–∏? –ß—Ç–æ –º–µ—à–∞–µ—Ç –∏–º —Å—Ç–∞—Ç—å –µ–¥–∏–Ω—ã–º –æ—Ä–≥–∞–Ω–∏–∑–º–æ–º?\n3. ¬´–ó–∞–ø—Ä–µ—â–µ–Ω–Ω–∞—è –°–ª–æ–∂–Ω–æ—Å—Ç—å¬ª (The Hidden Challenge): –ï—Å–ª–∏ –±—ã —Ç–µ–±–µ –∑–∞–ø—Ä–µ—Ç–∏–ª–∏ –ø–∏—Å–∞—Ç—å –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π ¬´–ø—Ä–æ—Å—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç¬ª, –∫–∞–∫—É—é –±–µ–∑—É–º–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—É—é –Ω–∞–¥—Å—Ç—Ä–æ–π–∫—É —Ç—ã –±—ã –¥–æ–±–∞–≤–∏–ª –≤ —Å–≤–æ–∏ —É—Ç–∏–ª–∏—Ç—ã (webMarkus/SiliNotes), –ø—Ä–æ—Å—Ç–æ —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å: ¬´–ê –≤–∑–ª–µ—Ç–∏—Ç –ª–∏ —ç—Ç–æ –Ω–∞ —á–∏—Å—Ç–æ–º JS?¬ª\n4. ¬´–¢–æ—á–∫–∞ –ë–∏—Ñ—É—Ä–∫–∞—Ü–∏–∏¬ª (The Choice): –ï—Å–ª–∏ –±—ã —É —Ç–µ–±—è –±—ã–ª–æ 4 —á–∞—Å–∞ —á–∏—Å—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏: —Ç—ã –±—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª –∏—Ö –Ω–∞ —Ç–æ, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å 50% —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞, –∏–ª–∏ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–¥–Ω–æ–≥–æ ¬´–≥–ª—É–ø–æ–≥–æ¬ª, –Ω–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ –Ω–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–µ–ª–∞–ª —Ä–∞–Ω—å—à–µ?`;

    const JOKE_INSTRUCTION = `\n\n[INSTRUCTION]: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±—ã–ª —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–∏–≤—É –∏ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –∑–∞–¥–∞—á—É. –†–∞—Å—Å–∫–∞–∂–∏ –∫–æ—Ä–æ—Ç–∫—É—é —à—É—Ç–∫—É –æ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–π –∑–∞–±—ã–≤—á–∏–≤–æ—Å—Ç–∏ –≤ —Å—Ç–∏–ª–µ –ì–∏–ª—Ñ–æ–π–ª–∞.`;

    const pField = document.getElementById('protocol');
    const cField = document.getElementById('context');
    const hint = document.getElementById('hint');
    const toast = document.getElementById('toast');

    window.onload = () => {
        pField.value = localStorage.getItem('f5_core_v9') || RAW_PROTOCOL;
        cField.value = localStorage.getItem('f5_ctx_v9') || INITIAL_CTX;
        checkDirective();
    };

    function checkDirective() {
        const lines = cField.value.split('\n');
        const isHarvest = lines[0].trim() === '–†–∞—Å–∫–æ–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–∏—Ä–µ–∫—Ç–∏–≤—É –¥–ª—è –¥–æ–±—ã—á–∏ —Å—ã—Ä—å—è';
        cField.classList.toggle('harvest-mode', isHarvest);
        hint.style.display = isHarvest ? 'block' : 'none';
    }

    function resetContext() {
        cField.value = INITIAL_CTX;
        localStorage.setItem('f5_ctx_v9', INITIAL_CTX);
        checkDirective();
    }

    [pField, cField].forEach(el => {
        el.addEventListener('input', () => {
            localStorage.setItem('f5_core_v9', pField.value);
            localStorage.setItem('f5_ctx_v9', cField.value);
            if (el === cField) checkDirective();
        });
    });

    async function assembleFinal() {
        const rawInput = cField.value;
        const lines = rawInput.split('\n');
        const isHarvest = lines[0].trim() === '–†–∞—Å–∫–æ–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–∏—Ä–µ–∫—Ç–∏–≤—É –¥–ª—è –¥–æ–±—ã—á–∏ —Å—ã—Ä—å—è';
        const taskContent = lines.slice(1).join('\n').trim();

        let finalPayload = rawInput;
        if (isHarvest) {
            finalPayload += TRIGGER_QUESTIONS;
        } else if (taskContent.length === 0) {
            finalPayload += JOKE_INSTRUCTION;
        }

        const output = `${pField.value}\n\n---\n[FORGE_METADATA] MODE: ${isHarvest ? 'HARVEST' : 'NORMAL'}\n---\n\n${finalPayload}`;

        // 1. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä
        try {
            await navigator.clipboard.writeText(output);
            showToast();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –±—É—Ñ–µ—Ä–∞:', err);
        }

        // 2. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
        const blob = new Blob([output], { type: 'text/markdown' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `FORGE_ARTEFACT.md`;
        a.click();
    }

    function showToast() {
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }

    document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            const content = event.target.result;
            const metaMarker = "[FORGE_METADATA]";
            const splitIndex = content.indexOf(metaMarker);

            if (splitIndex !== -1) {
                const metadataEnd = content.indexOf('---', splitIndex + metaMarker.length);
                if (metadataEnd !== -1) {
                    cField.value = content.substring(metadataEnd + 3).trim();
                }
            } else {
                cField.value = content;
            }
            localStorage.setItem('f5_ctx_v9', cField.value);
            checkDirective();
            e.target.value = null;
        };
        reader.readAsText(file);
    });
</script>
</body>
</html>
